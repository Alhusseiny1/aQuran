var app;app=angular.module("quran",["ngSanitize","ngStorage","ionic","mediaPlayer"]),app.constant("API","http://www.alfanous.org/jos2"),app.constant("EveryAyah","http://www.everyayah.com/data"),app.run(["$rootScope","AppCacheManager","Preferences","$window",function(e,r,n,t){return e.online=t.navigator.onLine,e.options=n,t.addEventListener("online",function(){return e.online=!0,e.$apply()}),t.addEventListener("offline",function(){return e.online=!1,e.$apply()})}]),app.config(["$stateProvider","$urlRouterProvider","$locationProvider","$logProvider",function(e,r){return e.state("reader",{url:"/reader/:current?highlight&scrollTo",templateUrl:"views/reader.html",controller:"ReadingController"}).state("aya",{url:"/aya/:gid?highlight",templateUrl:"views/aya.html",controller:"AyaController"}).state("navigate",{url:"/navigate",templateUrl:"views/navigation.html",controller:"NavigationController"}).state("search",{url:"/search?query",templateUrl:"views/search.html",controller:"SearchController"}).state("preferences",{url:"/preferences",templateUrl:"views/preferences.html",controller:"PreferencesController"}).state("themes",{url:"/preferences/themes",templateUrl:"views/themes.html",controller:"PreferencesController"}).state("sura-name",{url:"/preferences/sura_name",templateUrl:"views/sura_name.html",controller:"PreferencesController"}).state("explanations",{url:"/preferences/explanations",templateUrl:"views/explanations.html",controller:"ExplanationsController"}).state("recitations",{url:"/preferences/recitations",templateUrl:"views/recitations.html",controller:"RecitationsController"}).state("about",{url:"/about",templateUrl:"views/about.html",controller:["$http","$scope",function(e,r){return e.get("manifest.webapp",{headers:"application/json",cache:!0}).then(function(e){return r.info=e.data})}]}),r.otherwise("/reader/1")}]),app.controller("AyaController",["$scope","ContentService","$stateParams","$log",function(e,r,n){return e.progress={status:"init"},e.aya={gid:Number(n.gid||1)},r.then(function(r){return r.findOne(e.aya).exec().then(function(r){return e.aya=r,e.progress.status="ready"})})}]),app.controller("ExplanationsController",["$scope","$log","ExplanationService",function(e,r,n){return e.explanations={enabled:[],available:[]},n.properties.then(function(n){var t;return t=function(e){return _.chain(e).sortBy(["language","name"]).value()},e.toggle=function(r){return e.isEnabled(r)?_.remove(e.explanations.enabled,{id:r.id}):e.explanations.enabled.push(r),e.options.explanations.ids=_.pluck(e.explanations.enabled,"id")},e.isEnabled=function(r){return _.contains(e.options.explanations.ids,r.id)},n.find().exec().then(function(n){return r.debug(n),e.explanations.available=t(n),e.explanations.enabled=_.filter(e.explanations.available,function(r){return _.contains(e.options.explanations.ids,r.id)})})})["catch"](function(e){return r.error(e)})}]),app.controller("NavigationController",[function(){}]),app.controller("PreferencesController",["$scope","$log","ExplanationService",function(e){return e.sura_names=[{value:"sura_name",name:"Arabic",example:"الفاتحة"},{value:"sura_name_en",name:"English",example:"The Opening"},{value:"sura_name_romanization",name:"Romanized",example:"Al-Fatiha"}],e.$watch("options.reader.arabic_text",function(r){return r?void 0:e.options.explanations.enabled=!0}),e.themes=[{id:"light",name:"Light"},{id:"stable",name:"Stable"},{id:"positive",name:"Positive"},{id:"calm",name:"Calm"},{id:"balanced",name:"Balanced"},{id:"energized",name:"Energized"},{id:"assertive",name:"Assertive"},{id:"royal",name:"Royal"},{id:"dark",name:"Dark"}]}]),app.controller("ReadingController",["$rootScope","$scope","$state","$stateParams","$log","ContentService","Preferences",function(e,r,n,t,a,i){var o,u,c;return r.playlist=[],r.pages=[],r.view=_.defaults(t,r.options.reader.view),r.progress={status:"init",total:0,current:0},r.$watch("scrollTo",function(e,n){return e>n?r.loadMore():void 0}),c=function(e){return _.chain(e).map(function(e,n){return r.playlist.push(e.recitation),e.index=n,e}).value()},u=function(){var n;return n={},n[r.view.type]=r.view.current,i.then(function(e){return e.find(n).exec()}).then(c).then(function(n){return a.debug("Content ready",n),e.title=n[0].sura_name,r.progress.status="ready",n},o,function(e){return r.progress.message=e})},r.loadMore=function(){return r.view.current++,u().then(function(e){return r.pages.push(e),r.$broadcast("scroll.infiniteScrollComplete")})},u().then(function(e){return r.pages.push(e),r.options.first_time=!1,r.scrollTo=t.scrollTo}),o=function(e){return r.progress.status="error",r.error=e,a.error("Error",e)}}]),app.controller("RecitationsController",["$scope","$log","RecitationService",function(e,r,n){return e.recitations=[],n.properties.then(function(r){return r.find().exec().then(function(r){return e.recitations=_.chain(r).uniq(!0,"name").value()})})["catch"](function(e){return r.error(e)})}]),app.controller("SearchController",["$scope","$rootScope","$state","$log","$stateParams","SearchService","APIService",function(e,r,n,t,a,i,o){var u;return e.progress={status:"init",total:0,current:0,message:""},e.search={query:a.query||"",suggestions:[],results:[],execute:function(r){return null==r&&(r=e.search.query),r?(e.progress.status="searching",e.search.results=[],i.search(r).then(function(r){return t.debug("Found "+r.length+" results:",r),e.search.results=r,r})["catch"](function(e){if("NO_RESULTS"===e)return t.debug("No results found, going to fetch suggestions"),o.suggest(r);throw e}).then(function(r){return e.search.suggestions=r||[],t.debug("Suggestions:",e.search.suggestions),r}).then(function(){return e.progress.status="ready"})["catch"](u)):void 0}},e.search.execute(),u=function(r){return e.progress.status="error",e.error=r,t.error("Error:",r),e.$apply()}}]),app.directive("autoDirection",["LocalizationService",function(e){return{restrict:"ACE",link:function(r,n,t){return t.$observe("autoDirection",function(r){return r||(r=n.text()),n.attr("dir",e.isRTL(r)?"rtl":"ltr")})}}}]),app.directive("colorize",["ArabicService","$timeout","$log",function(e,r){var n;return n=function(r,n,t,a){var i;return null==a&&(a=!0),n&&t&&("string"==typeof t&&(t=e.getRegExp(t)),n=n.replace(t,"<span class='highlighted'>$1</span>")),i=a?r.split(/\s+/g).map(function(e){return"<span class='layers'> <span class='diacritics'>"+e+"</span> <span class='quranic-signs'>"+e+"</span> <span class='letters'>"+e+"</span> </span>"}).join(" "):r,n&&(i="<span class='search layers'> <span class='original'>"+n+"</span> <span class='overlay'>"+i+"</span> </span>"),i},{restrict:"A",replace:!0,link:function(e,t,a){return r(function(){var e,r,i,o;return e=!1,a.colorize&&"false"!==a.colorize&&(e=!0),o=a.colorizeText,r=a.highlight,i=a.searchText,o=n(o,i,r,e),t.html(o)})}}}]),app.directive("emphasize",["$timeout",function(e){return{restrict:"A",replace:!0,link:function(r,n,t){var a;return a=function(e,r){var n;return n=new RegExp("("+r+")","gi"),console.log(e.replace(n,"<em>$1</em>")),e.replace(n,"<em>$1</em>")},e(function(){var e;return e=t.emphasize,n.html(a(n.text(),e))})}}}]),app.directive("scrollTo",["$location","$anchorScroll","$timeout",function(e,r,n){var t;return t=function(r){return r?e.hash(""+r):void 0},{restrict:"A",replace:!1,link:function(e,a,i){return i.$observe("scrollTo",function(a){return e.$watch("$location.hash",function(){return n(r)}),t(a)})}}}]),app.factory("AudioSrcFactory",["$sce","EveryAyah","Preferences","RecitationService","$q","CacheService","$log",function(e,r,n,t,a,i,o){var u,c,s,l;return l=function(e,r){for(;r>0;)e+=e,r--;return e},u=function(e){return Math.max.apply(Math,e)},c=function(e){return Math.min.apply(Math,e)},s=function(e,r){return null==r&&(r="3"),e=l("0",r)+e,e.substr(e.length-3)},function(l,p){var f,d,h;return l=s(l),p=s(p),n.audio.auto_quality&&navigator.mozConnection?(f=function(){var e,r;return e=i.get("audio:"+n.audio.recitation.name+":quality"),e?a.when(e):(r=function(e){var r,t,a;return r=_.clone(e),t=n.connection.auto?navigator.mozConnection.bandwidth:n.connection.bandwidth,o.debug("Bandwidth:",t),o.debug("Available:",r),a=function(){switch(t){case 1/0:return u(r);default:return _.remove(r,function(e){return 8*e/1024>t}),u(r)}}(),0===r.length?c(e):a},t.properties.then(function(e){return e.find().where("name").is(n.audio.recitation.name).exec()}).then(function(e){return o.debug(e),e.map(function(e){return Number(e.subfolder.match(/(\d+)kbps/i)[1])})}).then(r).then(function(e){return i.put("audio:"+n.audio.recitation.name+":quality",e),e}))},f().then(function(t){var a;return a=n.audio.recitation.subfolder.match(/^(.+)_\d+kbps/i)[1],h=""+a+"_"+t+"kbps",d=""+r+"/"+h+"/"+l+p+".mp3",{src:e.trustAsResourceUrl(d),type:"audio/mp3"}})):(h=n.audio.recitation.subfolder,d=""+r+"/"+h+"/"+l+p+".mp3",a.when({src:e.trustAsResourceUrl(d),type:"audio/mp3"}))}}]),app.factory("ExplanationFactory",["ExplanationService",function(e){return function(r,n){return e.load(r).then(function(e){return e.findOne({gid:n}).exec()})}}]);var __slice=[].slice;app.factory("IDBStoreFactory",["$q","$http","$log","QueryBuilder","Preferences",function(e,r,n,t,a){return function(i,o){var u,c,s,l,p,f,d;return d=!1,o=_.defaults(o,{dbVersion:1,storePrefix:"",transforms:[],transformResponse:function(e){return e.data}}),c=e.defer(),l=function(){return c.notify({action:"STORE.FETCHING",data:{storeName:o.storeName}}),r.get(i,{cache:!0}).then(o.transformResponse)},u=function(){var r;return r=e.defer(),f.clear(function(){return r.resolve()},function(e){return n.error(e),r.reject(e)}),r.promise},p=function(r){var t;return c.notify({action:d?"STORE.UPDATING":"STORE.INSERTING",data:{storeName:o.storeName}}),t=e.defer(),f.putBatch(r,function(){return n.info("Data inserted."),a[""+o.storeName+"-version"]=o.dbVersion,t.resolve(f)},function(e){return t.reject(e)}),t.promise},s=function(e){return{find:function(){var r,n;return r=1<=arguments.length?__slice.call(arguments,0):[],(n=t(e,o.transforms)).find.apply(n,r)},findOne:function(){var r,n;return r=1<=arguments.length?__slice.call(arguments,0):[],(n=t(e,o.transforms)).findOne.apply(n,r)},findById:function(){var r,n;return r=1<=arguments.length?__slice.call(arguments,0):[],(n=t(e,o.transforms)).findById.apply(n,r)},findOneById:function(){var r,n;return r=1<=arguments.length?__slice.call(arguments,0):[],(n=t(e,o.transforms)).findOneById.apply(n,r)},where:function(){var r,n;return r=1<=arguments.length?__slice.call(arguments,0):[],(n=t(e,o.transforms)).where.apply(n,r)}}},f=new IDBStore(o),f.onStoreReady=function(){var e;return e=a[""+o.storeName+"-version"],e=e?Number(e):-1,e>-1&&(d=!0),Number(a[""+o.storeName+"-version"]===o.dbVersion)?c.resolve(f):e>o.dbVersion?u().then(l).then(p).then(c.resolve):l().then(p).then(c.resolve)},f.onError=function(e){return c.reject(e)},c.promise.then(s)}}]);var __slice=[].slice;app.factory("QueryBuilder",["$q","$log",function(e){return function(r,n){var t,a,i,o,u,c,s,l,p,f,d,h,m,g,v,y,x,b,w,S;return h=void 0,m=void 0,g=void 0,S=void 0,f=!1,d=!1,x="ASC",y=!1,w=n||[],b=function(e){return e instanceof Array?(g=e[0],S=e[1]||null):(g=e,S=g)},v=function(){var e;if(!g&&!S)return void 0;try{return r.makeKeyRange({lower:Math.min(g,S),excludeLower:f,upper:Math.max(g,S),excludeUpper:d})}catch(n){return e=n,g}},t=function(){var n,t,a,i;return n=e.defer(),i=function(e){return n.resolve(e)},t=function(e){return n.reject(e)},a={index:h,keyRange:v(),order:x,onError:t},r.query(i,a),n.promise.then(function(r){return w.length?e.all(r.map(function(e){var r,n,t;for(n=0,t=w.length;t>n;n++)r=w[n],e=r(e);return e})):r}).then(function(e){return y&&(e=e[0]||null),e})},l=function(e){return w.push(e),{exec:t}},c=function(e){return m=e,{limit:e,transform:l,exec:t}},s=function(e){return(-1===Number(e)||e.match(/^des/gi))&&(x="DESC"),{limit:c,transform:l,exec:t}},p=function(e){var r,n,a;return h=e,r=function(e,r){return g=e,S=r,f=!0,d=!0,{limit:c,sort:s,transform:l,exec:t}},n=function(e){return g=e,{limit:c,sort:s,transform:l,exec:t,to:function(e){return S=e,{limit:c,sort:s,transform:l,exec:t}}}},a=function(e){return e?(g=e,S=e,{exec:t}):{exec:t,from:n,between:r,transform:l}},{between:r,is:a,from:n,limit:c,exec:t,transform:l}},a=function(){var e,r,n;switch(r=arguments[0],n=2<=arguments.length?__slice.call(arguments,1):[],!1){case!(!r||"string"==typeof r):return h=r,b(n),{exec:t,where:p,limit:c,sort:s,transform:l};case"object"!=typeof r:if(e=_.keys(r),_.include(e,"limit")&&(c(r.limit),_.pull(e,"limit")),_.include(e,"sort")&&(s(r.sort),_.pull(e,"sort")),e.length>1)throw"QueryBuilder is limited to one key per query";return h=e[0],n=r[h],b(n),{exec:t,limit:c,sort:s,transform:l}}},o=function(){var e;return e=1<=arguments.length?__slice.call(arguments,0):[],y=!0,e&&delete e.limit,c(1),a.apply(null,e)},i=function(){var e,r;return e=arguments[0],r=2<=arguments.length?__slice.call(arguments,1):[],h="id",a.apply(null,r)},u=function(){var e,r;return e=arguments[0],r=2<=arguments.length?__slice.call(arguments,1):[],h="id",o.apply(null,r)},{transform:l,find:a,findOne:o,findById:i,findOneById:u,where:p}}}]),app.filter("arabicNumber",["ArabicService",function(e){return function(r){return e.Numbers.Array.forEach(function(e,n){return r=r.replace(new RegExp(n.toString,"g"),n.toLocaleString())}),r}}]),app.filter("progress",[function(){var e;return e={"STORE.FETCHING":"Loading ${storeName} database from the server...","STORE.INSERTING":"Storing ${storeName} for offline use...","STORE.UPDATING":"Updating ${storeName} database..."},function(r){return _.template(e[r.action],r.data)}}]),app.service("APIService",["API","$http","$log",function(e,r,n){var t;return t=function(e){if(e.data.error.code===!0)throw"API Error";return e},{query:function(n){return r.get(e,{cache:!0,params:_.defaults(n,{action:"search",unit:"aya",traduction:1,fuzzy:"True"})})},suggest:function(a){return r.get(e,{params:{query:a,action:"suggest",unit:"aya"}}).then(t).then(function(e){var r;return n.debug("Response for suggestions",e),r=[],_(e.data.suggest).each(function(e,n){return e.forEach(function(e){return r.push({string:a.replace(n,e),replace:n,"with":e})})}),_.remove(r,{string:a}),r})}}}]),app.service("AppCacheManager",["$window","$rootScope","$log",function(e,r,n){return e.applicationCache.onchecking=function(e){return n.info("AppCache Checking...",e)},e.applicationCache.onupdateready=function(e){return n.info("AppCache Update Ready",e)},e.applicationCache.onobsolete=function(e){return n.info("AppCache Obsolete",e)},e.applicationCache.ondownloading=function(e){return n.info("AppCache Downloading...",e)},e.applicationCache.onprogress=function(e){return n.info("AppCache in progress",e)},e.applicationCache.onerror=function(e){return n.error("AppCache Error",e)},e.applicationCache.oncached=function(e){return n.info("AppCache Cached",e)},e.applicationCache}]),app.service("ArabicService",[function(){var e,r,n,t,a,i;return e=/[\u060c-\u06fe\ufb50-\ufefc]/g,r="([ًࣰًٌࣱٍࣲؘَؙُؚِّْٗ٘ۡ.smallَ.smallࣱ.smallُ.smallࣰ.smallٌ.smallٗ.smallِ.smallٍ.smallْ.small2ِ.small2َ.small2ٗ.urd])",a=/[\u0615\u0617\u065C\u0670\u06D6\u06D7\u06D8\u06D9\u06DA\u06DB\u06DC\u06DD\u06DE\u06DF\u06E0\u06E2\u06E3\u06E4\u06E5\u06E6\u06E7\u06E8\u06E9\u06EA\u06EB\u06EC\u06ED\u0670.isol\u0670.medi\u06E5.medi\u06E6]/,n="([آإأءئؤاىو])",t=["٠","١","٢","٣","٤","٥","٦","٧","٨","٩"],i=[{id:"alefHamzas",replace:/[أإآا]/g,"with":"[أإآا]"},{id:"alefMadda",replace:/آ|(?:ءا)/g,"with":"(?:آ|(?:ءا))"}],{getRegExp:function(e){return i.forEach(function(r){return e=e.replace(r.replace,r["with"])}),new RegExp("("+e+")","g")},Alphabet:{RegExp:e},Diacritics:{RegExp:new RegExp(r,"g"),String:r},Hamzas:{String:n,RegExp:new RegExp(n,"g")},Numbers:{Array:t},Quranic:{Sign:{RegExp:a}}}}]),app.service("CacheService",["$cacheFactory",function(e){return e("CacheService")}]),app.service("ContentService",["IDBStoreFactory","ExplanationFactory","AudioSrcFactory","Preferences","$q","$log",function(e,r,n,t,a,i){return e("resources/quran.json",{dbVersion:7,storeName:"ayas",keyPath:"gid",autoIncrement:!1,indexes:[{name:"gid",unique:!0},{name:"page_id"},{name:"sura_id"},{name:"aya_id"},{name:"standard"}],transforms:[function(e){return e.sura_name=e[t.reader.sura_name],e.text=function(){switch(!1){case!!t.reader.diacritics:return e.standard;case!(t.reader.standard_text&&t.reader.diacritics):return e.standard_full;default:return e.uthmani}}(),e},function(e){return t.explanations.enabled?a.all(t.explanations.ids.map(function(n){return r(n,e.gid)})).then(function(r){return e.explanations=r,e}):a.when(e)},function(e){return e.then(function(e){return t.audio.enabled?n(e.sura_id,e.aya_id).then(function(r){return e.recitation=r,e}):e})}]})["catch"](function(e){return i.error(e)})}]),app.service("ExplanationService",["IDBStoreFactory","$log",function(e,r){var n,t;return n=[],t=e("resources/translations.json",{dbVersion:3,storeName:"explanations",keyPath:"id",autoIncrement:!1,indexes:[{name:"id",unique:!0},{name:"country"},{name:"language"}]}),{properties:t,load:function(a){return n["trans:"+a]||(n["trans:"+a]=t.then(function(e){return e.findOne({id:a}).exec()}).then(function(r){return e("resources/translations/"+r.file,{transformResponse:function(e){return e.data.split(/\n/g).map(function(e,r){return{gid:r+1,text:e}})},dbVersion:r.version||1,storeName:a,keyPath:"gid",autoIncrement:!1,indexes:[{name:"gid",unique:!0}],transforms:[function(e){return _.extend(e,r)}]})}).then(function(e){return r.debug("Store ready for explanation "+a),e})["catch"](function(e){return r.error(e)}))}}}]),app.service("LocalizationService",function(){var e,r;return r=function(e){return e.replace(/@\w+/,"")},e=function(e,r){var n;return n=e.match(new RegExp(r,"g")),n?n.length:0},{isRTL:function(n){var t;return n=r(n),t=e(n,"[\\u060C-\\u06FE\\uFB50-\\uFEFC]"),100*t/n.length>20}}}),app.service("NavigationService",[function(){return{go:function(e){return{aya_id:e.match(/(?!aya\s*(\d+))|\d+\W(\d+)/gi)[1],page_id:e.match(/page\s*(\d+)/gi)[1],sura_id:e.match(/(?!surah*\s*(\d+))|(d+)\W\d+/gi)[1],sura_name:e.match(/surah*\s*(\D+)/gi)[1]}}}}]),app.service("Preferences",["$localStorage",function(e){var r;return r={first_time:!0,theme:"balanced",search:{history:[],max_history:10,online:{enabled:!1,prompt:!0}},explanations:{enabled:!0,ids:["ar.muyassar","en.ahmedali"]},reader:{arabic_text:!0,standard_text:!1,diacritics:!0,view:{type:"page_id",current:1,total:604},colorized:!0,aya_mode:"uthmani",sura_name:"sura_name_romanization",sura_name_transliteration:!0},audio:{recitation:{subfolder:"Abdul_Basit_Murattal_64kbps",name:"Abdul Basit Murattal",bitrate:"64kbps"},auto_quality:!0,enabled:!0},connection:{bandwidth:1/0,auto:!0}},e.$default(r)}]),app.service("RecitationService",["IDBStoreFactory",function(e){var r;return r=e("resources/recitations.json",{dbVersion:1,storeName:"recitations",keyPath:"subfolder",autoIncrement:!1,indexes:[{name:"subfolder",unique:!0},{name:"name"},{name:"bitrate"}]}),{properties:r}}]),app.service("SearchService",["APIService","ContentService","ArabicService","Preferences","$log","$http","$q",function(e,r,n,t,a,i,o){var u,c,s,l;return u=void 0,s=function(){return u=i.get("resources/search.json",{cache:!0}).then(function(e){return e.data}).then(function(e){var r,n;return n=o.defer(),r=new Nedb,r.insert(e,function(e){if(e)throw e;return n.resolve(r)}),n.promise})},c=function(e){var n;return n=o.defer(),r.then(function(r){return async.mapLimit(e,10,function(e,n){return r.findOne({gid:e.gid}).exec().then(function(e){return n(null,e)})},function(r,t){if(r)throw r;return n.resolve(_.merge(e,t))})}),n.promise},l={},l.online=function(r){return a.debug("Searching online..."),e.query({action:"search",unit:"aya",traduction:1,query:r,sortedBy:"mushaf",word_info:"False",recitation:0,aya_position_info:"True",aya_sajda_info:"False",fuzzy:"True",script:"standard",vocalized:"True",range:"25",perpage:"25"}).then(function(e){var r;return a.debug("Online search response:",e),r=_(e.data.search.ayas).map(function(e,r){return{gid:e.identifier.gid,index:r}}).toArray().sortBy("index").value()})},l.offline=function(e,r){return(u||s()).then(function(t){var a,i,u,c;return a=o.defer(),r.srtictDiacritics?(c=new RegExp("[](?! "+n.Diacritics.String+")","g"),e=e.replace(c,0/0+n.Diacritics.String+")*"),r.field="standard_full"):e=e.replace(n.Diacritics.RegExp,""),r.ignoreHamzaCase&&(e=e.replace(n.Hamzas.RegExp,n.Hamzas.String)),e=e.replace(/\s{2,}/g," "),e=e.trim(),u=new RegExp(e,"gi"),i={},i[r.field]={$regex:u},t.find(i).sort({gid:1}).exec(function(e,r){if(e)throw e;return a.resolve(r)}),a.promise})},{search:function(e,r){var n;return null==r&&(r={}),r=_.defaults(r,{matches:"autocomplete",srtictDiacritics:!1,ignoreHamzaCase:!0,onlyStartAya:!1,wholeWord:!0,scope:"all",sort:[{sura_id:1},{aya_id:1}],limit:0,skip:0,field:"standard",online:t.search.online.enabled}),e?(n="offline",r.online&&(n="online"),l[n](e,r)["catch"](function(t){if("offline"!==n)return l.offline(e,r);throw t}).then(c).then(function(r){if(r.length)return _.pull(t.search.history,e),t.search.history.unshift(e),t.search.history=t.search.history.slice(0,t.search.max_history),r;throw"NO_RESULTS"})):o.reject("NO_QUERY")}}}]);